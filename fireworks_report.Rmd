---
title: "Stirling & Bridge of Allan Round Table"
output: 
  html_document:
    df_print: paged
    code_folding: hide
    toc: true
    toc_float: true
    number_sections: true
---

<style>
div.hidecode + pre {display: none}
</style>
<script>
doclick=function(e){
e.nextSibling.nextSibling.style.display="block";
}
</script>

<center>
![](images/table.png)
</center>

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      message = FALSE, fig.align = 'center')
library(tidyverse)
library(ggplot2)
library(janitor)
library(leaflet)
library(readxl)
library(lubridate)
library(stringi)
```

```{r}
summary <- read_excel(
              "raw_data/BridgeofAllanCharityBonfireNight_2021-11-08.xlsx", 
              sheet = "Daily Summary")

event1356 <- read_excel(
              "raw_data/BridgeofAllanCharityBonfireNight_2021-11-08.xlsx", 
              sheet = "Event1356",
              skip = 7) %>% 
              clean_names() 

event1356 <- event1356[-1,]
event1356

uk_postcode <- read_csv("raw_data/ukpostcodes.csv")

combine <- left_join(event1356, uk_postcode, by = "postcode")
```

```{r}
combine %>% 
  filter(is.na(latitude))
```
```{r}
uk_postcode %>% 
  filter(postcode == "ML9 1AQ")
```

```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode)) %>% 
  filter(postcode %in% "PH336 XE")
```


```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode)) %>% 
  filter(postcode %in% "FK5 4")
```

```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode)) %>% 
  filter(postcode %in% "FK9 5 JF")
```

```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode)) %>% 
  filter(postcode %in% "ML9 1AQ")
```


```{r}
`%!in%` <- negate(`%in%`)

event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
         postcode = trimws(postcode),
         postcode = ifelse(nchar(postcode) < 6,
         postcode,
         ifelse(str_detect(postcode, "\\s"),
                postcode,
                paste0(substr(postcode, start = 1, stop = (nchar(postcode)-3)),
                       " ", substr(postcode, start = (nchar(postcode)-2),
                                   stop = nchar(postcode))))),
         postcode = case_when( postcode == "FK10 WTF" ~ "FK10 2TF",
                               postcode == "PH336 XE" ~ "PH33 6XE",
                               postcode == "FK9 5 JF" ~ "FK9 5JF",
                               postcode == "FK10 3 NR" ~ "FK10 3NR",
                               postcode == "ML9  1AQ" ~ "ML9 1AQ",
                               TRUE ~ postcode)
          ) %>% 
  left_join(uk_postcode, by = "postcode") %>% 
  select(postcode, latitude) %>%
  filter(is.na(latitude)) 
  # filter(postcode == str_detect(postcode,
  #                                  pattern = "^[0-9]{3,}"))
```

```{r}
testcode <- c("EH1 1AD", "EH1 1AE", "EH13 5ED", "GA3 9RD", "FK15 8ED", "Fk81tu", "FK159DY", "69005", "FK54UP", "FK10 WTF", "FK94DQ", "FK102ET", "FK159JE", "FK95HQ", "PH20BL")

 
ifelse(nchar(testcode) < 6,
       testcode,
       ifelse(str_detect(testcode, "\\s"),
              testcode,
              paste0(substr(testcode, start = 1, stop = (nchar(testcode)-3)),
                     " ", substr(testcode, start = (nchar(testcode)-2),
                                 stop = nchar(testcode)))))
```




```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
         #postcode = 
           ) %>% 
  filter(str_detect(postcode, pattern = "^[0-9]{3,}"))
```


69005 45.7583° N, 4.7991° E Lyon
20159 45.4982° N, 9.1918° E Milan
08015 41.3786° N, 2.1524° E Barcelona
75018 48.8913° N, 2.3530° E Paris
97330 44.6385° N, 123.2929° W Oregon
74960 35.7837° N, 94.6037° W Oklahoma

```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = if_else(str_detect(postcode,
        pattern = "[0-9]+[A-Z]{2}$"),
        gsub(postcode, "(^[A-Z]{2}+[0-9]{1,})([0-9]{1}+[A-Z]{2}$)", 
             "\\1 \\2", gsub(" ", "", postcode)), postcode)
           ) %>% 
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))
```

event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = if_else(str_detect(postcode,
        pattern = "[0-9]+[A-Z]{2}$"),
        gsub("(^[A-Z]{2}+[0-9]{1,})([0-9]{1}+[A-Z]{2}$)", "\\1 \\2"), postcode)
           ) %>% 
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))

event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = if_else(str_detect(postcode,
        pattern = "^[A-Z]{2}+[0-9]{1,}+[0-9]+[A-Z]{2}$"),
        gsub("([0-9])([0-9]+[A-Z]{2}$)", "\\1 \\2"), postcode)
           ) %>% 
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))
  
  Error: Problem with `mutate()` column `postcode`.
i `postcode = if_else(...)`.
x argument "x" is missing, with no default
  
  event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = if_else(str_detect(postcode,
        pattern = "[0-9]{2}+[A-Z]{2}$"),
        gsub(postcode, "(^[A-Z]{2}+[0-9])([0-9]{1}+[A-Z]{2}$)", "\\1 \\2"), postcode)
           ) %>% 
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))
  
  event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = if_else(str_detect(postcode,
        pattern = "^[A-Z]{2}+[0-9]{1,}+[0-9]+[A-Z]{2}$"),
        gsub(postcode, "(^[A-Z]{2}+[0-9])([0-9]{1}+[A-Z]{2}$)", "\\1 \\2"), postcode)
           ) %>% 
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))
  
  Warning: Problem with `mutate()` column `postcode`.
i `postcode = if_else(...)`.
i argument 'pattern' has length > 1 and only the first element will be used

```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = case_when(
          postcode %in% "[0-9]{2}+[A-Z]{2}$" ~ " [0-9]+[A-Z]{2}$",
          TRUE ~ postcode)
           ) %>%
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))
```

```{r}
event1356 %>% 
  mutate(postcode = str_to_upper(postcode),
        postcode = case_when(
          postcode %in% "[0-9]{2}+[A-Z]{2}$" ~ gsub(postcode,
                                      "(^[A-Z]{2}+[0-9])([0-9]{1}+[A-Z]{2}$)", 
                                      "\\1 \\2", postcode),
          TRUE ~ postcode)
           ) %>%
  filter(str_detect(postcode, pattern = "[0-9]{2}+[A-Z]{2}$"))
```


```{r}
postcode
```


```{r}

```

```{r}
tail(event1356)
```

```{r}
summary(event1356)  
```

```{r}
event1356 %>% 
  select(mandatory_covid_vaccination_t_cs) %>% 
  filter(!is.na(mandatory_covid_vaccination_t_cs))
```


```{r}
event1356 %>% 
  select(other_comments) %>% 
  filter(!is.na(other_comments))
```

```{r}
event1356 %>% 
  select(organisation) %>% 
  filter(!is.na(organisation))
```

```{r}
event1356 %>% 
  filter(!str_detect(organisation, "^(?i)na"),
         !str_detect(organisation, "Road"),
         !str_detect(organisation, "6"),
         !str_detect(organisation, "kennedy"),
         !str_detect(organisation, "Douglas"),
         !str_detect(organisation, "Miss"),
         !str_detect(organisation, "Select"),
         !str_detect(organisation, "none")
         ) %>%
  group_by(organisation) %>% 
  count(organisation)
```
35 people from 28 organisation fill this part in, with 1677 not using it so would be worth taking this out.

Removed from organisation: 

  * Two house address 
  * Two full names
  * Someone title 
  * Two miss inputs 


```{r}
event1356 %>% 
  select(email) %>% 
  mutate(email = str_replace(email, 
                             pattern = "^[a-zA-Z0-9\\._%-]+@", 
                             replacement = ""),
         email = str_to_lower(email)) %>%
  group_by(email) %>% 
  count(email) %>% 
  arrange(desc(n))
```

84 unique email domain. Coming from 48 providers or industry's. 


```{r}
event1356 %>% 
  select(email) %>% 
  mutate(email = str_replace(email, 
                             pattern = "^[a-zA-Z0-9\\._%-]+@", 
                             replacement = ""),
         email = str_to_lower(email),
         email = str_replace_all(email, 
                                 pattern = "[a-z\\._%-]+.ac.uk",
                                 replacement = "university"),
         email = str_replace_all(email, 
                                 pattern = "[a-z]+.edu",
                                 replacement = "education"),
         email = str_replace_all(email, 
                                 pattern = "[a-z]+school[a-z]?",
                                 replacement = "education"),
         email = str_replace_all(email, 
                                 pattern =  "[a-z]+academy[a-z\\.]?",
                                 replacement = "education"),
         email = str_replace_all(email, 
                                 pattern = 
                                             "[a-z]+.org",
                                 replacement = "nonprofit"),
         email = str_extract(email,
                             pattern ="^[a-zA-Z0-9_%-]+"),
         email = case_when(email == "hotmail" ~ "microsoft",
                           email == "themcnaughts" ~ "microsoft",
                           email == "outlook" ~ "microsoft",
                           email == "live" ~ "microsoft",
                           email == "msn" ~ "microsoft",
                           email == "passport" ~ "microsoft",
                           email == "gmail" ~ "google",
                           email == "google" ~ "google",
                           email == "googlemail" ~ "google",
                           email == "icloud" ~ "apple",
                           email == "me" ~ "apple",
                           email == "mac" ~ "apple",
                           email == "love" ~ "aol",
                           email == "ygm" ~ "aol",
                           email == "games" ~ "aol",
                           email == "wow" ~ "aol",
                           email == "ymail" ~ "yahoo",
                           email == "cybg" ~ "virgin",
                           email == "blueyonder" ~ "virgin",
                           email == "virginmedia" ~ "virgin",
                           email == "btconnect" ~ "bt",
                           email == "btopenworld" ~ "bt",
                           email == "btinternet" ~ "bt",
                           email == "nonprofite" ~ "nonprofit",
                           TRUE ~ email
                           )
         ) %>%
  group_by(email) %>% 
  count(email) %>% 
  arrange(desc(n))
```


